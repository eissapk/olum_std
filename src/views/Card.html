<template>
  <div class="Card">
    ${ !hasError && this.data && this.members ? `

    <div class="Card__header">
      <section class="Card__header__type">
        <img src="${this.data.type == 'bug' ? bugIcon : this.data.type == 'task' ? taskIcon : ''}" alt="${this.data.type}" />
        ${this.data.type.upper()}-${this.data.id}
      </section>
      <button type="button" class="Card__header--delBtn">${icons.trash}</button>
    </div>

    <div class="Card__inner">
      <div class="Card__inner__content">
        <div class="Card__inner__content__title">
          <input type="text" value="${this.data.title}" />
        </div>

        <div class="Card__inner__content__desc">
          <p class="hint">Description</p>
          <div contenteditable="true" class="content">${this.data.desc}</div>
        </div>

        <div class="Card__inner__content__comments">
          <p class="hint">Comments</p>
          <input type="text" placeholder="Add a comment..." />

          ${this.data.comments.length ? this.data.comments.map(item => `
          <div class="Card__inner__content__comments__comment">
            <div class="Card__inner__content__comments__comment__username">
              <img src="${this.members[item.user]}" alt="${item.user}" />
              <span>${item.user}</span>
            </div>
            <div class="Card__inner__content__comments__comment__content">${item.content}</div>
          </div>
          `).join("") : "" }
        </div>
      </div>

      <div class="Card__inner__info">
        <div class="Card__inner__info__column">
          <p class="hint">Column</p>
          <span>${this.data.column.title}</span>
        </div>

        <div class="Card__inner__info__reporter">
          <p class="hint">Reporter</p>
          <div>
            <img src="${this.members[this.data.reporter]}" alt="${this.data.reporter}" />
            <span>${this.data.reporter}</span>
          </div>
        </div>

        <div class="Card__inner__info__assignees">
          <p class="hint">Assignees</p>

          ${this.data.assignees.length ? this.data.assignees.map(item => `
          <div class="Card__inner__info__assignees__assignee">
            <img src="${this.members[item]}" alt="${item}" />
            <span>${item}</span>
            <button type="button">${icons.close}</button>
          </div>
          `).join("") : "" }
          <a href="javascript:void(0)">+ Add Assignee</a>
        </div>

        <div class="Card__inner__info__priority">
          <p class="hint">Priority</p>
          <div>
            <img
              src="${this.data.priority == 'low' ? lowIcon : this.data.priority == 'medium' ? mediumIcon : this.data.priority == 'high' ? highIcon : ''}"
              alt="${this.data.priority}"
            />
            <span>${this.data.priority}</span>
          </div>
        </div>

        <div class="Card__inner__info__time">
          <p>Created - ${this.data.time.created}</p>
          ${this.data.time.updated ? `
          <p>Updated - ${this.data.time.updated}</p>
          ` : ""}
        </div>
      </div>
    </div>

    ` : hasError ? "Error while fetching data!" : isLoading ? "Loading..." : "" }
  </div>
</template>

<script>
  import { Origin, $, debug } from "olum-helpers";
  import router from "../router/index.js";
  import icons from "../services/icons.js";
  import bugIcon from "../assets/bug.png";
  import taskIcon from "../assets/task.png";
  import lowIcon from "../assets/low.png";
  import mediumIcon from "../assets/medium.png";
  import highIcon from "../assets/high.png";
  let hasError = false;
  let isLoading = true;
  export default class Card {
    render() {
      this.origin = new Origin();
      const { id } = router.params;
      this.getData(id);
    }

    getData(id) {
      this.origin
        .get("http://localhost:3000/cards/" + id)
        .then(data => {
          this.origin
            .get("http://localhost:3000/members")
            .then(members => {
              this.displayCard(data, members);
            })
            .catch(err => {
              console.error(err);
              hasError = true;
              this.updateTemp();
            });
        })
        .catch(err => {
          console.error(err);
          hasError = true;
          this.updateTemp();
        });
    }

    displayCard(data, members) {
      this.data = data;
      this.members = members;
      debug([data, members]);
      hasError = false;
      isLoading = false;
      this.updateTemp();
    }
    
    updateTemp() {
      $(".Card").innerHTML = this.template(true);
    }
  }
</script>

<style lang="scss">
  @import "../styles/Card.scss";
</style>
